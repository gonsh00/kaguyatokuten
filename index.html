<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>かぐや様は設定差をバラされたい</title>
  <meta name="description" content="ごん氏オリジナル設定判別ツール" />
  <style>
    :root{
      --bg:#0f1220;
      --card:#171a2b;
      --text:#e7e9f3;
      --muted:#a0a6c3;
      --primary:#5b8cff;
      --accent:#ff76a6;
      --ok:#32d583;    /* 高設定: 緑 */
      --mid:#3aa0ff;   /* 中間設定: 青 */
      --low:#ff5d5d;   /* 低設定: 赤 */
      --btn:#20243a;
      --btn-border:#2b3150;
      --badge:#2d3356;
      --overlay-bg: rgba(20,24,43,.55);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family: system-ui, -apple-system, Segoe UI, Roboto, "ヒラギノ角ゴ ProN", "Hiragino Kaku Gothic ProN", "Noto Sans JP", "メイリオ", Meiryo, sans-serif}
    a{color:inherit}

    .wrap{max-width:720px;margin:0 auto;padding:16px 16px 96px}

    header{position:relative;display:flex;flex-direction:column;gap:0;margin:8px -8px 14px;overflow:hidden}
    header .logo{display:block;width:100%;height:128px;object-fit:cover;object-position:center}
    /* Overlay chips on header image */
    header .title, header .brand, header .theme{
      position:absolute;z-index:2;border:1px solid var(--btn-border);
      background:var(--overlay-bg);backdrop-filter: blur(6px);
      box-shadow: 0 6px 16px rgba(0,0,0,.22);
    }
    header .title{left:12px;bottom:40px;padding:6px 10px;border-radius:10px}
    header .brand{left:12px;bottom:10px;padding:4px 8px;border-radius:8px}
    header .theme{top:8px;right:8px}
    .title{font-size:20px;font-weight:800}
    .brand{font-size:12px;color:var(--muted)}

    .card{background:var(--card);border:1px solid var(--btn-border);border-radius:14px;padding:14px}

    .result{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      text-align:center;gap:6px;padding:18px;border-radius:12px;
      background:linear-gradient(160deg, #1b1f36 0%, #14182b 100%);
      border:1px solid var(--btn-border);
      margin-bottom:12px;
      min-height:88px;
    }
    .result-label{font-size:12px;color:var(--muted)}
    .result-value{font-size:28px;font-weight:900;letter-spacing:1px}
    .result-high{color:var(--ok)}
    .result-mid{color:var(--mid)}
    .result-low{color:var(--low)}
    .result-sp{color:var(--accent)}

    .kv{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:8px 0}
    .kv .item{background:var(--btn);border:1px solid var(--btn-border);padding:8px 10px;border-radius:10px;font-size:12px;color:var(--muted)}
    .kv .item strong{color:var(--text)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .btn{
      position:relative;
      background:var(--btn);
      border:1px solid var(--btn-border);
      color:var(--text);
      border-radius:12px;
      padding:14px;
      font-size:15px;
      text-align:left;
      min-height:60px;
      box-shadow: 0 1px 0 rgba(0,0,0,.25) inset, 0 0 0 0 rgba(0,0,0,0);
      transition: transform .02s ease, background .2s ease, border-color .2s ease;
    }
    .btn:active{transform: scale(.98)}
    .btn .label{display:block;font-weight:700;margin-bottom:6px}
    .btn .score{font-size:12px;color:var(--muted)}
    .btn .badge{
      position:absolute;right:8px;top:8px;min-width:28px;height:22px;padding:0 8px;
      display:inline-flex;align-items:center;justify-content:center;
      background:var(--badge);border-radius:999px;border:1px solid var(--btn-border);
      font-size:12px;color:#cdd3ff
    }

    .controls{display:flex;gap:10px;margin:12px 0}
    .controls .cbtn{
      flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      background:#222743;border:1px solid var(--btn-border);color:var(--text);
      padding:12px;border-radius:12px;font-weight:700
    }
    .controls .cbtn.reset{background:#2a1f2a}

    .inputs{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;margin:8px 0}
    .input{display:flex;flex-direction:column;gap:6px}
    .input label{font-size:12px;color:var(--muted)}
    .input input{
      background:var(--btn);color:var(--text);
      border:1px solid var(--btn-border);
      padding:12px;border-radius:10px;font-size:16px;
    }

    .judge{
      width:100%;margin-top:8px;background:linear-gradient(90deg, var(--primary), #8e78ff);
      color:white;border:none;border-radius:12px;padding:14px;font-weight:900;font-size:16px
    }

    footer.sticky{
      position:fixed;left:0;right:0;bottom:0;background:rgba(15,18,32,.9);
      backdrop-filter: blur(6px);border-top:1px solid var(--btn-border);
    }
    .foot{max-width:720px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .foot .chip{background:var(--card);border:1px solid var(--btn-border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    .foot .chip strong{color:var(--text)}

    /* Password Gate */
    .gate{position:fixed;inset:0;background:radial-gradient(1200px 400px at 50% -20%, #273056, #0f1220 60%)}
    .gate-inner{height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .gate-card{width:100%;max-width:420px}
    .gate-card h1{margin:0 0 8px;font-size:22px}
    .gate-card p{margin:0 0 14px;color:var(--muted);font-size:13px}
    .gate-row{display:flex;gap:8px}
    .gate-row input{flex:1;background:var(--btn);color:var(--text);border:1px solid var(--btn-border);border-radius:10px;padding:12px;font-size:16px}
    .gate-row button{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:800}
    .gate-err{color:var(--low);font-size:12px;margin-top:8px;min-height:16px}

    /* Theme toggle button */
    .theme{align-self:flex-end;background:var(--btn);border:1px solid var(--btn-border);color:var(--text);border-radius:999px;padding:6px 10px;font-size:12px}

    /* Light theme overrides */
    :root[data-theme="light"]{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f1220;
      --muted:#5a6280;
      --primary:#4a6cff;
      --accent:#e84f9a;
      --ok:#16a34a;
      --mid:#2563eb;
      --low:#dc2626;
      --btn:#f1f3fb;
      --btn-border:#e1e5f2;
      --badge:#e9ecf8;
      --overlay-bg: rgba(255,255,255,.65);
    }
  </style>
</head>
<body>
  <!-- Password Gate -->
  <div id="gate" class="gate">
    <div class="gate-inner">
      <div class="gate-card card">
        <header>
          <div class="title">かぐや様は設定差をバラされたい</div>
          <div class="brand">ごん氏オリジナル設定判別ツール</div>
        </header>
        <p>パスワードを入力してください</p>
        <div class="gate-row">
          <input id="gateInput" type="password" placeholder="Password" autocomplete="off" inputmode="text" />
          <button id="gateBtn" aria-label="unlock">解錠</button>
        </div>
        <div id="gateErr" class="gate-err"></div>
      </div>
    </div>
  </div>

  <div id="app" class="wrap" style="display:none">
    <header>
      <img id="headerLogo" class="logo" src="images/IMG_header2.jpg" alt="サイトロゴ" />
      <button id="themeToggle" class="theme" type="button" aria-label="テーマ切替">🌙 ダーク</button>
      <div class="title">かぐや様は設定差をバラされたい</div>
      <div class="brand">ごん氏オリジナル設定判別ツール</div>
    </header>

    <section class="result">
      <div class="result-label">判定結果</div>
      <div id="resultValue" class="result-value">未判定</div>
    </section>

    <section class="card">
      <div class="kv">
        <div class="item">累積得点 y: <strong id="yVal">0.0</strong></div>
        <div class="item">x: <strong id="xVal">0</strong></div>
      </div>

      <div class="grid" id="eventsGrid"><!-- buttons inserted by JS --></div>

      <div class="controls">
        <button id="undoBtn" class="cbtn" type="button">↶ 取り消し</button>
        <button id="resetBtn" class="cbtn reset" type="button">リセット</button>
      </div>

      <div class="inputs">
        <div class="input">
          <label for="bbInput">BB回数</label>
          <input id="bbInput" type="number" inputmode="numeric" pattern="[0-9]*" step="1" min="0" placeholder="0" />
        </div>
        <div class="input">
          <label for="rbInput">RB回数</label>
          <input id="rbInput" type="number" inputmode="numeric" pattern="[0-9]*" step="1" min="0" placeholder="0" />
        </div>
        <div class="input">
          <label for="gameInput">総回転数</label>
          <input id="gameInput" type="number" inputmode="numeric" pattern="[0-9]*" step="1" min="0" placeholder="0" />
        </div>
      </div>

      <button id="judgeBtn" class="judge" type="button">判定</button>
    </section>
  </div>

  <footer class="sticky">
    <div class="foot">
      <div class="chip">累積得点 y: <strong id="yValFooter">0.0</strong></div>
      <div class="chip">x: <strong id="xValFooter">0</strong></div>
    </div>
  </footer>

  <script>
    // ===== Config =====
    const PASSWORD = "KSMarriage"; // 注意: クライアント側のみの簡易保護です

    const EVENTS = [
      { key: 'kukan_head_ext', label: '区間頭EXT', score: 3.0 },
      { key: 'hatuatari_ext_rate', label: '初当たりEXT率', score: 2.5 },
      { key: 'kukan_nai_ext', label: '区間内EXT', score: 1.5 },
      { key: 'hatuatari_aka7', label: '初当たり赤7', score: 1.3 },
      { key: 'ren2_4_aka7', label: '2~4連目赤7', score: 1.2 },
      { key: 'rb_hikimodoshi_bb_1g', label: 'RB引き戻しBBで1G連', score: 0.7 },
      { key: 'chokugeki', label: '直撃', score: 0.4 },
      { key: 'rb_1g_get', label: 'RB1G連獲得', score: 0.2 },
      { key: 'bb_afteratari_hikimodoshi', label: 'BB初当たり後引き戻し', score: 0.1 },
      { key: 'bb_tanpatsu', label: 'BB単発', score: -0.1 },
      { key: 'rb_hikimodoshi_bb_tanpatsu', label: 'RB引き戻しBB単発', score: -0.6 },
    ];

    // ===== State =====
    const counts = Object.fromEntries(EVENTS.map(e => [e.key, 0]));
    let history = []; // stack of keys for undo
    let totalY = 0.0;

    // ===== Elements =====
    const gateEl = document.getElementById('gate');
    const gateInput = document.getElementById('gateInput');
    const gateBtn = document.getElementById('gateBtn');
    const gateErr = document.getElementById('gateErr');

    const appEl = document.getElementById('app');
    const yVal = document.getElementById('yVal');
    const xVal = document.getElementById('xVal');
    const yValFooter = document.getElementById('yValFooter');
    const xValFooter = document.getElementById('xValFooter');
    const eventsGrid = document.getElementById('eventsGrid');
    const resultValue = document.getElementById('resultValue');

    const bbInput = document.getElementById('bbInput');
    const rbInput = document.getElementById('rbInput');
    const gameInput = document.getElementById('gameInput');
    const judgeBtn = document.getElementById('judgeBtn');
    const undoBtn = document.getElementById('undoBtn');
    const resetBtn = document.getElementById('resetBtn');
    const themeToggle = document.getElementById('themeToggle');

    // ===== Helpers =====
    const vibrate = (ms=12) => {
      if (navigator.vibrate) try { navigator.vibrate(ms); } catch(_){}
    };

    const fmtY = (v) => (Math.round(v * 10) / 10).toFixed(1);

    function getIntFromInput(inputEl){
      const raw = (inputEl.value || '').trim();
      if (raw === '') return 0;
      // accept only digits
      if (!/^\d+$/.test(raw)) return NaN;
      const n = parseInt(raw, 10);
      if (n < 0) return NaN;
      return n;
    }

    function updateTotalsUI(){
      yVal.textContent = fmtY(totalY);
      yValFooter.textContent = fmtY(totalY);
      const x = calcX();
      xVal.textContent = Number.isFinite(x) ? x : '-';
      xValFooter.textContent = Number.isFinite(x) ? x : '-';
    }

    function calcX(){
      const bb = getIntFromInput(bbInput);
      const rb = getIntFromInput(rbInput);
      const gm = getIntFromInput(gameInput);
      if (!Number.isFinite(bb) || !Number.isFinite(rb) || !Number.isFinite(gm)) return NaN;
      return gm + (bb * 35) + (rb * 10);
    }

    function thresholds(x){
      const upper = 0.00000005 * x * x + 0.0002 * x + 0.2076;
      const lower = -0.00000003 * x * x + 0.0004 * x - 0.1827;
      return { upper, lower };
    }

    function judge(){
      const x = calcX();
      if (!Number.isFinite(x)){
        resultValue.className = 'result-value';
        resultValue.textContent = '入力を確認してください';
        return;
      }
      const { upper, lower } = thresholds(x);
      const y = totalY;
      let label = '中間設定';
      let cls = 'result-mid';
      if (y >= upper + 2){
      label = '高設定濃厚！？';
      cls = 'result-sp';
      } else if (y > upper){
      label = '高設定かも？';
      cls = 'result-high';
      } else if (y < lower){
       label = '低設定';
       cls = 'result-low';
      }
      resultValue.className = 'result-value ' + cls;
      resultValue.textContent = label;
    }

    function addEvent(key, score){
      counts[key] += 1;
      history.push(key);
      totalY += score;
      // update badge
      const badge = document.getElementById('count-' + key);
      if (badge) badge.textContent = counts[key];
      updateTotalsUI();
      vibrate(10);
    }

    function undo(){
      if (history.length === 0) return;
      const key = history.pop();
      const ev = EVENTS.find(e => e.key === key);
      if (!ev) return;
      if (counts[key] > 0) counts[key] -= 1;
      totalY -= ev.score;
      const badge = document.getElementById('count-' + key);
      if (badge) badge.textContent = counts[key];
      updateTotalsUI();
      vibrate(8);
    }

    function resetAll(){
      Object.keys(counts).forEach(k => counts[k] = 0);
      history = [];
      totalY = 0.0;
      // reset badges
      EVENTS.forEach(e => {
        const badge = document.getElementById('count-' + e.key);
        if (badge) badge.textContent = '0';
      });
      // reset inputs
      bbInput.value = '';
      rbInput.value = '';
      gameInput.value = '';
      resultValue.className = 'result-value';
      resultValue.textContent = '未判定';
      updateTotalsUI();
      vibrate(6);
    }

    function buildEventButtons(){
      const frag = document.createDocumentFragment();
      EVENTS.forEach(ev => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.type = 'button';
        btn.id = 'btn-' + ev.key;
        btn.setAttribute('aria-label', `${ev.label}（${ev.score > 0 ? '+' : ''}${ev.score}）`);
        btn.innerHTML = `
          <span class="label">${ev.label}</span>
          <span class="score">${ev.score > 0 ? '+' : ''}${ev.score}</span>
          <span class="badge" id="count-${ev.key}">0</span>
        `;
        btn.addEventListener('click', () => addEvent(ev.key, ev.score));
        frag.appendChild(btn);
      });
      eventsGrid.appendChild(frag);
    }

    function enforceIntegerInput(el){
      // prevent non-digit characters
      el.addEventListener('input', () => {
        const v = el.value;
        const cleaned = v.replace(/[^\d]/g, '');
        if (v !== cleaned) el.value = cleaned;
        updateTotalsUI();
      });
      el.addEventListener('blur', () => {
        // remove leading zeros (normalize)
        if (/^\d+$/.test(el.value)) el.value = String(parseInt(el.value || '0', 10));
        updateTotalsUI();
      });
    }

    // ===== Gate logic =====
    function tryUnlock(){
      const pass = gateInput.value;
      if (pass === PASSWORD){
        gateErr.textContent = '';
        gateEl.style.display = 'none';
        appEl.style.display = '';
        vibrate(14);
      } else {
        gateErr.textContent = 'パスワードが違います';
        vibrate(40);
      }
    }

    gateBtn.addEventListener('click', tryUnlock);
    gateInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') tryUnlock();
    });

    // ===== Init =====
    buildEventButtons();
    enforceIntegerInput(bbInput);
    enforceIntegerInput(rbInput);
    enforceIntegerInput(gameInput);
    updateTotalsUI();

    // Buttons
    judgeBtn.addEventListener('click', () => { judge(); vibrate(8); });
    undoBtn.addEventListener('click', () => undo());
    resetBtn.addEventListener('click', () => resetAll());
    // Theme toggle init
    (function initTheme(){
      const root = document.documentElement;
      root.setAttribute('data-theme', 'dark');
      if (themeToggle){
        themeToggle.addEventListener('click', () => {
          const cur = root.getAttribute('data-theme') || 'dark';
          const next = cur === 'dark' ? 'light' : 'dark';
          root.setAttribute('data-theme', next);
          themeToggle.textContent = next === 'dark' ? '🌙 ダーク' : '☀️ ライト';
          vibrate(6);
        });
      }
    })();
  </script>
</body>
</html>
